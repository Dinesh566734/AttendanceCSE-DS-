<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Attendance System For CSE(DS)</title>
<style>
  body { font-family: 'Segoe UI', sans-serif; background-color: #eef2f7; margin: 0; padding: 0; }
  header { background-color: #2c3e50; color: white; padding: 20px; text-align: center; }
  .container { max-width: 1100px; margin: 40px auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
  h2 { margin-top: 0; color: #2c3e50; }
  .hidden { display: none; }
  table { border-collapse: collapse; width: 100%; margin-top: 20px; }
  th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
  th { background-color: #34495e; color: white; }
  tr:nth-child(even) { background-color: #f8f9fb; }
  tr:hover { background-color: #f1f5f9; }
  button { margin: 10px 5px; padding: 10px 18px; border: none; border-radius: 4px; background-color: #3498db; color: white; cursor: pointer; }
  button:hover { background-color: #2980b9; }
  .danger-btn { background-color: #e74c3c; }
  .danger-btn:hover { background-color: #c0392b; }
  select, input[type="text"], input[type="password"] { padding: 10px; width: 100%; margin: 5px 0; border: 1px solid #ccc; border-radius: 4px; }
  input[type="checkbox"] { width: 22px; height: 22px; cursor: pointer; }
  .diag { font-size: 12px; color: #555; }
</style>
</head>
<body>
<header>
  <h1>Attendance Management System for CSE(DS)</h1>
</header>
<div class="container">

<div id="login-section">
  <h2>Secure Login</h2>
  <label>Username:<input type="text" id="username" placeholder="Enter username"></label>
  <label>Password:<input type="password" id="password" placeholder="Enter password"></label>
  <button id="loginBtn">Login</button>
  <p id="login-message" style="color:red;"></p>
  <div id="diag" class="diag"></div>
</div>

<div id="attendance-section" class="hidden">
  <h2>Mark Attendance</h2>
  <label>Select Day: <select id="day-select" onchange="loadAttendance()"></select></label>
  <table id="attendance-table">
    <thead>
      <tr id="table-header"></tr>
    </thead>
    <tbody id="attendance-body"></tbody>
  </table>
  <button onclick="saveAttendance()">Save Attendance</button>
  <button onclick="loadAttendance()">Load Attendance</button>
  <button onclick="logout()" class="danger-btn">Logout</button>
</div>

</div>

<script type="module">
  // Firebase v9 modular SDK
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
  import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

  // --- Firebase config ---
  const firebaseConfig = {
    apiKey: "AIzaSyCTx8SuwqsqqVzgsfPkaaMEirYeKWCqC5Y",
    authDomain: "attendance-dd096.firebaseapp.com",
    projectId: "attendance-dd096",
    storageBucket: "attendance-dd096.appspot.com",
    messagingSenderId: "1064169386680",
    appId: "1:1064169386680:web:301de8d261c27216aeba4d",
    measurementId: "G-6XS9BM0852"
  };

  // Init Firebase/Firestore
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // --- App data ---
  const USER_CREDENTIALS = { username: 'teacher', password: 'pass123' };

  const students = [
    "R23XV1M6701 - Addanki Harshitha",
    "R23XV1M6702 - Agalduvity Rohit",
    "R23XV1M6703 - Ananthula Akhil Kumar",
    "R23XV1M6704 - Arudra Thrived Sai",
    "R23XV1M6705 - Asmita Samayam"
  ];

  const subjectsByDay = {
    'Monday': ['AI', 'ADA', 'CN-Lab', 'SMD'],
    'Tuesday': ['IDA', 'AI', 'ADA', 'ACS-Lab'],
    'Wednesday': ['IDA', 'Assignment', 'CN', 'SMD', 'KOFKA'],
    'Thursday': ['IDA', 'R-Lab', 'CN', 'IPR'],
    'Friday': ['AI', 'CN-Lab Assignment', 'IDA', 'Hackathon'],
    'Saturday': ['Aptitude Class']
  };

  // --- UI wiring ---
  const loginBtn = document.getElementById('loginBtn');
  loginBtn.addEventListener('click', onLogin);

  function onLogin() {
    const user = document.getElementById('username').value.trim();
    const pass = document.getElementById('password').value.trim();
    if (user === USER_CREDENTIALS.username && pass === USER_CREDENTIALS.password) {
      document.getElementById('login-section').classList.add('hidden');
      document.getElementById('attendance-section').classList.remove('hidden');
      populateDayDropdown();
      document.getElementById('day-select').selectedIndex = 0;
      loadAttendance();
    } else {
      document.getElementById('login-message').textContent = '❌ Invalid username or password';
    }
  }

  function logout() {
    document.getElementById('attendance-section').classList.add('hidden');
    document.getElementById('login-section').classList.remove('hidden');
  }

  function populateDayDropdown() {
    const select = document.getElementById('day-select');
    select.innerHTML = '';
    Object.keys(subjectsByDay).forEach(day => {
      const option = document.createElement('option');
      option.value = day;
      option.textContent = day;
      select.appendChild(option);
    });
  }

  function buildTable(subjects) {
    const headerRow = document.getElementById('table-header');
    headerRow.innerHTML = '<th>Student</th>' + subjects.map(sub => `<th>${sub}</th>`).join('');
    const tbody = document.getElementById('attendance-body');
    tbody.innerHTML = '';
    students.forEach(student => {
      const row = document.createElement('tr');
      row.innerHTML = `<td>${student}</td>` + subjects.map(() => `<td><input type="checkbox"></td>`).join('');
      tbody.appendChild(row);
    });
  }

  async function saveAttendance() {
    const day = document.getElementById('day-select').value;
    const rows = document.querySelectorAll('#attendance-body tr');
    const subjects = subjectsByDay[day];
    const data = {};
    rows.forEach(row => {
      const student = row.cells[0].textContent;
      data[student] = [];
      for (let i = 1; i <= subjects.length; i++) {
        data[student].push(row.cells[i].firstChild.checked);
      }
    });
    await setDoc(doc(db, 'attendance', day), data);
    alert('✅ Attendance saved to Firestore!');
  }

  async function loadAttendance() {
    const day = document.getElementById('day-select').value;
    buildTable(subjectsByDay[day]);
    const snap = await getDoc(doc(db, 'attendance', day));
    if (snap.exists()) {
      const data = snap.data();
      const rows = document.querySelectorAll('#attendance-body tr');
      rows.forEach(row => {
        const student = row.cells[0].textContent;
        if (data[student]) {
          data[student].forEach((present, idx) => {
            row.cells[idx + 1].firstChild.checked = !!present;
          });
        }
      });
    }
  }

  // --- Expose functions to global for inline handlers ---
  // (Because this script uses type="module", functions are scoped to the module by default.)
  window.saveAttendance = saveAttendance;
  window.loadAttendance  = loadAttendance;
  window.logout          = logout;

  // --- Minimal diagnostics (test cases) ---
  (function runDiagnostics(){
    const log = [];
    log.push(['global saveAttendance', typeof window.saveAttendance === 'function']);
    log.push(['global loadAttendance', typeof window.loadAttendance === 'function']);
    log.push(['global logout', typeof window.logout === 'function']);
    log.push(['Firestore initialized', !!db]);
    document.getElementById('diag').textContent =
      'Diagnostics → ' + log.map(([k,v]) => `${k}: ${v ? 'OK' : 'FAIL'}`).join(' | ');
    console.table(log.map(([k,v]) => ({ check: k, ok: !!v })));
  })();
</script>
</body>
</html>
