<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Attendance System For CSE(DS)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background-color: #eef2f7; margin: 0; padding: 0; }
    header { background-color: #2c3e50; color: white; padding: 20px; text-align: center; }
    .container { max-width: 1100px; margin: 40px auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    h2 { margin-top: 0; color: #2c3e50; }
    .hidden { display: none; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
    th { background-color: #34495e; color: white; }
    tr:nth-child(even) { background-color: #f8f9fb; }
    tr:hover { background-color: #f1f5f9; }
    button { margin: 10px 5px; padding: 10px 18px; border: none; border-radius: 4px; background-color: #3498db; color: white; cursor: pointer; transition: background-color 0.3s; }
    button:hover { background-color: #2980b9; }
    button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
    .danger-btn { background-color: #e74c3c; }
    .danger-btn:hover { background-color: #c0392b; }
    .success-btn { background-color: #27ae60; }
    .success-btn:hover { background-color: #229954; }
    select, input[type="text"], input[type="password"], input[type="date"], input[type="number"] { padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 4px; width: 100%; max-width: 300px; }
    input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom: 10px; }
    .muted { color:#6b7280; font-size: 0.95rem; }
    .notice { background:#fff3cd; color:#856404; border:1px solid #ffeeba; padding:15px; border-radius:6px; margin:10px 0; }
    .success { background:#d4edda; color:#155724; border:1px solid #c3e6cb; padding:15px; border-radius:6px; margin:10px 0; }
    .error { background:#f8d7da; color:#721c24; border:1px solid #f5c6cb; padding:15px; border-radius:6px; margin:10px 0; }
    small { display:block; color:#6b7280; margin-top: 5px; }
    #qr-box { display:flex; gap:16px; align-items:flex-start; margin-top: 15px; }
    #qrcode { padding:15px; background:#fff; border:2px solid #e5e7eb; border-radius:8px; display: inline-block; }
    code.kbd { background:#111827; color:#f9fafb; padding:2px 6px; border-radius:4px; }
    .loading { opacity: 0.7; pointer-events: none; }
    .status-indicator { padding: 8px 12px; border-radius: 4px; font-weight: bold; margin: 10px 0; }
    .qr-session-active { border-left: 4px solid #27ae60; }
    .mobile-friendly { max-width: 100%; overflow-x: auto; }
    
    @media (max-width: 768px) {
      .container { margin: 10px; padding: 15px; }
      .row { flex-direction: column; align-items: stretch; }
      button { width: 100%; margin: 5px 0; }
      select, input { max-width: 100%; }
      table { font-size: 12px; }
      th, td { padding: 5px; }
    }
  </style>
</head>
<body>
<header>
  <h1>Attendance System for CSE(DS)</h1>
</header>
<div class="container">

  <!-- LOGIN -->
  <div id="login-section">
    <h2>Secure Login</h2>
    <p class="muted">Sign in with your registered email address.</p>
    <div class="row">
      <div>
        <label>Email:</label>
        <input type="email" id="username" placeholder="Enter email" autocomplete="username" />
      </div>
      <div>
        <label>Password:</label>
        <input type="password" id="password" placeholder="Enter password" autocomplete="current-password" />
      </div>
    </div>
    <div class="row">
      <button id="login-btn">Login</button>
      <button id="forgot-btn" type="button">Forgot Password</button>
    </div>
    <div id="login-feedback"></div>
  </div>

  <!-- APP -->
  <div id="attendance-section" class="hidden">
    <div class="row" style="justify-content: space-between; align-items: center;">
      <h2 style="margin: 0;">Attendance Management</h2>
      <button id="logout-btn" class="danger-btn">Logout</button>
    </div>

    <div id="user-role-info" class="muted"></div>
    
    <!-- Controls -->
    <div class="row">
      <div>
        <label>Select Day:</label>
        <select id="day-select">
          <option value="Monday">Monday</option>
          <option value="Tuesday">Tuesday</option>
          <option value="Wednesday">Wednesday</option>
          <option value="Thursday">Thursday</option>
          <option value="Friday">Friday</option>
          <option value="Saturday">Saturday</option>
        </select>
      </div>
      <div>
        <label>Date:</label>
        <input type="date" id="date-select">
      </div>
      <div>
        <label>Saved Records:</label>
        <select id="saved-dates">
          <option value="">-- Select Saved Record --</option>
        </select>
      </div>
    </div>

    <!-- QR SESSION (TEACHER) -->
    <div id="qr-session-section" class="notice" style="display:none;">
      <h3>QR Code Session (Teacher)</h3>
      <div class="row">
        <div>
          <label>Subject:</label>
          <select id="subject-select"></select>
        </div>
        <div>
          <label>Classroom Radius (meters):</label>
          <input id="radius-input" type="number" min="10" max="200" value="35" />
        </div>
        <div>
          <label>Session Duration (minutes):</label>
          <input id="expire-mins" type="number" min="1" max="15" value="5" />
        </div>
      </div>
      <div class="row">
        <button id="set-location-btn">Set Current Location as Classroom</button>
        <button id="start-qr-btn" class="success-btn">Start QR Session</button>
        <button id="end-qr-btn" class="danger-btn" style="display:none;">End Session</button>
      </div>
      
      <div id="session-status" class="status-indicator" style="display:none;"></div>
      
      <div id="qr-display" class="hidden">
        <div id="qr-box">
          <div id="qrcode"></div>
          <div>
            <div id="qr-info"></div>
            <small>Students: Scan this QR code with your camera and allow location access to mark attendance.</small>
          </div>
        </div>
      </div>
    </div>

    <!-- STUDENT QR SCAN -->
    <div id="student-scan-section" class="notice" style="display:none;">
      <h3>Mark Your Attendance</h3>
      <div class="row">
        <input type="text" id="qr-input" placeholder="Paste QR code content here or scan with camera" />
        <button id="mark-attendance-btn" class="success-btn">Submit Attendance</button>
      </div>
      <div id="scan-feedback"></div>
    </div>

    <!-- ATTENDANCE TABLE -->
    <div class="mobile-friendly">
      <table id="attendance-table">
        <thead>
          <tr id="table-header"></tr>
        </thead>
        <tbody id="attendance-body"></tbody>
      </table>
    </div>

    <!-- CONTROLS -->
    <div id="teacher-controls" class="row">
      <button id="add-subject-btn">Add Subject</button>
      <button id="save-btn" class="success-btn">Save Attendance</button>
      <button id="export-btn">Export CSV</button>
    </div>

    <!-- Add Subject Modal -->
    <div id="add-subject-modal" class="hidden">
      <div class="row">
        <input type="text" id="new-subject-input" placeholder="Enter subject name" />
        <button id="confirm-add-subject">Add</button>
        <button id="cancel-add-subject">Cancel</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
  // Simulated Firebase-like functionality for demo
  // In production, replace with actual Firebase imports
  
  const firebaseConfig = {
    // Your Firebase config here
    apiKey: "demo",
    authDomain: "demo.firebaseapp.com",
    projectId: "demo",
    storageBucket: "demo.appspot.com",
    messagingSenderId: "demo",
    appId: "demo"
  };

  // Student data
  const students = [
    "R23XV1M6701 - Addanki Harshitha",
    "R23XV1M6702 - Agalduvity Rohit",
    "R23XV1M6703 - Ananthula Akhil Kumar",
    "R23XV1M6704 - Arudra Thrived Sai",
    "R23XV1M6705 - Asmita Samayam",
    "R23XV1M6706 - Bolladi Yashwanth Reddy",
    "R23XV1M6707 - Chanda Pranav",
    "R23XV1M6708 - Chiguru Varun",
    "R23XV1M6709 - Duddu Harshavardhan",
    "R23XV1M6710 - Gadde Yaksha",
    "R23XV1M6711 - Gannavarapu Sai Jaiwanth",
    "R23XV1M6712 - Gopagani Prabhas Aryan",
    "R23XV1M6713 - Gorijavolu Ramphani Prasad",
    "R23XV1M6714 - GVS Lalitha Siva Priya",
    "R23XV1M6715 - Jerripotula Dharan Premjee",
    "R23XV1M6716 - Kadiri Hitesh Reddy",
    "R23XV1M6717 - Kandagaddala Lakshmi Venkateswarachaitanya",
    "R23XV1M6718 - Kandagaddala Lakshmi Vyshnavi",
    "R23XV1M6719 - Katta Yogith Reddy",
    "R23XV1M6720 - Kotha Venkata Sourav Sohil",
    "R23XV1M6721 - Krapa Harsha Vardhan",
    "R23XV1M6722 - Kuntla Sri Sahithi",
    "R23XV1M6723 - Lalithadithya Reddy Chintalapudi",
    "R23XV1M6724 - Manaswini Koratagiri",
    "R23XV1M6725 - Manikanti Gayatri Reddy",
    "R23XV1M6726 - Maranani Dinesh Kumar",
    "R23XV1M6727 - Mohammed Nahid Hasan",
    "R23XV1M6728 - Mothe Venkatnath Reddy",
    "R23XV1M6729 - Moturu Sai Gagana Laasya",
    "R23XV1M6730 - Muppidi Saika Brinda",
    "R23XV1M6731 - Pasumarthi Vaibhav",
    "R23XV1M6732 - Rishika Cherupelly",
    "R23XV1M6733 - Rohan Sreeharsha Srikakulam",
    "R23XV1M6734 - Saathvik Varma Mandapati",
    "R23XV1M6735 - Shaik Taufeeq Ahmad",
    "R23XV1M6736 - Shrihari Bhide",
    "R23XV1M6737 - Sonti Krishna Keerthana",
    "R23XV1M6738 - Sowmya Adluri",
    "R23XV1M6739 - Sresta Bhupathi",
    "R23XV1M6740 - Supraja Ananthula",
    "R23XV1M6741 - T Shashidhar Yadav",
    "R23XV1M6742 - Talabhattula Dheeraj Krishna",
    "R23XV1M6743 - Tanmay Gunnam",
    "R23XV1M6744 - Tata Sucheth",
    "R23XV1M6745 - Tera Daiva Prem",
    "R23XV1M6746 - Tumma Nikhil Kumar",
    "R23XV1M6747 - V Arun Raj Goud",
    "R23XV1M6748 - Valluri Vamshi Krishna Bharadwaj",
    "R23XV1M6749 - Vuddanti Hima Varenya",
    "R23XV1M6750 - Yamini Lokesh"
  ];

  const subjectsByDay = {
    'Monday': ['AI', 'ADA', 'CN-Lab', 'SMD'],
    'Tuesday': ['IDA', 'AI', 'ADA', 'ACS-Lab'],
    'Wednesday': ['IDA', 'Assignment', 'CN', 'SMD', 'KOFKA'],
    'Thursday': ['IDA', 'R-Lab', 'CN', 'IPR'],
    'Friday': ['AI', 'CN-Lab Assignment', 'IDA', 'Hackathon'],
    'Saturday': ['Aptitude Class']
  };

  // Global state
  let currentUser = null;
  let currentRole = 'teacher'; // 'teacher' or 'student' or 'viewer'
  let activeSession = null;
  let classroomLocation = { lat: 17.385044, lon: 78.486671 }; // Default classroom coordinates

  // DOM elements
  const $ = (id) => document.getElementById(id);
  const loginSection = $('login-section');
  const attendanceSection = $('attendance-section');
  const loginFeedback = $('login-feedback');
  const userRoleInfo = $('user-role-info');
  const daySelect = $('day-select');
  const dateSelect = $('date-select');
  const savedDates = $('saved-dates');
  const qrSessionSection = $('qr-session-section');
  const studentScanSection = $('student-scan-section');
  const subjectSelect = $('subject-select');
  const radiusInput = $('radius-input');
  const expireMinsInput = $('expire-mins');
  const teacherControls = $('teacher-controls');
  const tableHeader = $('table-header');
  const attendanceBody = $('attendance-body');

  // Initialize
  document.addEventListener('DOMContentLoaded', () => {
    setupEventListeners();
    initializeApp();
  });

  function setupEventListeners() {
    // Login
    $('login-btn').addEventListener('click', handleLogin);
    $('forgot-btn').addEventListener('click', handleForgotPassword);
    $('logout-btn').addEventListener('click', handleLogout);

    // Attendance controls
    daySelect.addEventListener('change', handleDayChange);
    dateSelect.addEventListener('change', loadAttendance);
    savedDates.addEventListener('change', handleSavedDateSelect);

    // Teacher controls
    $('set-location-btn').addEventListener('click', setClassroomLocation);
    $('start-qr-btn').addEventListener('click', startQRSession);
    $('end-qr-btn').addEventListener('click', endQRSession);
    $('add-subject-btn').addEventListener('click', showAddSubjectModal);
    $('save-btn').addEventListener('click', saveAttendance);
    $('export-btn').addEventListener('click', exportCSV);

    // Student controls
    $('mark-attendance-btn').addEventListener('click', markAttendanceFromQR);

    // Subject modal
    $('confirm-add-subject').addEventListener('click', addSubject);
    $('cancel-add-subject').addEventListener('click', hideAddSubjectModal);
  }

  function initializeApp() {
    // Set default date to today
    dateSelect.value = new Date().toISOString().split('T')[0];
    
    // Show login by default
    showLogin();
    
    // Check for URL parameters (QR scan)
    checkForQRScan();
  }

  function showLogin() {
    loginSection.classList.remove('hidden');
    attendanceSection.classList.add('hidden');
  }

  function showApp() {
    loginSection.classList.add('hidden');
    attendanceSection.classList.remove('hidden');
    
    setupUserInterface();
    loadSubjects();
    buildAttendanceTable();
    loadSavedDates();
  }

  function setupUserInterface() {
    userRoleInfo.textContent = `Signed in as: ${currentUser?.email || 'Demo User'} — Role: ${currentRole}`;
    
    if (currentRole === 'teacher') {
      qrSessionSection.style.display = '';
      studentScanSection.style.display = 'none';
      teacherControls.style.display = '';
      
      // Enable all controls
      daySelect.disabled = false;
      dateSelect.disabled = false;
    } else if (currentRole === 'student') {
      qrSessionSection.style.display = 'none';
      studentScanSection.style.display = '';
      teacherControls.style.display = 'none';
      
      // Disable editing controls
      daySelect.disabled = true;
      dateSelect.disabled = true;
    } else { // viewer
      qrSessionSection.style.display = 'none';
      studentScanSection.style.display = 'none';
      teacherControls.style.display = 'none';
      
      // Disable editing controls
      daySelect.disabled = true;
      dateSelect.disabled = true;
    }
  }

  async function handleLogin() {
    const email = $('username').value.trim();
    const password = $('password').value.trim();
    
    if (!email || !password) {
      showFeedback('login-feedback', 'Please enter both email and password', 'error');
      return;
    }
    
    // Simulate login - replace with actual Firebase auth
    try {
      currentUser = { email, uid: 'demo-uid-' + Math.random() };
      
      // Determine role based on email domain or other logic
      if (email.includes('teacher') || email.includes('admin')) {
        currentRole = 'teacher';
      } else if (email.includes('student')) {
        currentRole = 'student';
      } else {
        currentRole = 'viewer';
      }
      
      showFeedback('login-feedback', 'Login successful!', 'success');
      setTimeout(showApp, 1000);
    } catch (error) {
      showFeedback('login-feedback', 'Login failed: ' + error.message, 'error');
    }
  }

  async function handleForgotPassword() {
    const email = $('username').value.trim();
    if (!email) {
      showFeedback('login-feedback', 'Please enter your email address', 'notice');
      return;
    }
    
    showFeedback('login-feedback', `Password reset link sent to ${email}`, 'success');
  }

  function handleLogout() {
    currentUser = null;
    currentRole = null;
    activeSession = null;
    $('username').value = '';
    $('password').value = '';
    showLogin();
  }

  function handleDayChange() {
    loadSubjects();
    buildAttendanceTable();
  }

  function handleSavedDateSelect() {
    const selectedRecord = savedDates.value;
    if (!selectedRecord) return;
    
    const [day, date] = selectedRecord.split('_');
    if (day && date) {
      daySelect.value = day;
      dateSelect.value = date;
      loadSubjects();
      loadAttendance();
    }
  }

  function loadSubjects() {
    const selectedDay = daySelect.value;
    const subjects = subjectsByDay[selectedDay] || [];
    
    // Update subject select for QR sessions
    subjectSelect.innerHTML = '';
    subjects.forEach((subject, index) => {
      const option = document.createElement('option');
      option.value = index;
      option.textContent = subject;
      subjectSelect.appendChild(option);
    });
  }

  function buildAttendanceTable() {
    const selectedDay = daySelect.value;
    const subjects = subjectsByDay[selectedDay] || [];
    
    // Build header
    tableHeader.innerHTML = '<th>Student</th>' + 
      subjects.map(subject => `<th>${subject}</th>`).join('');
    
    // Build body
    attendanceBody.innerHTML = '';
    students.forEach(student => {
      const row = document.createElement('tr');
      row.innerHTML = `<td>${student}</td>` + 
        subjects.map(() => `<td><input type="checkbox" ${currentRole === 'viewer' ? 'disabled' : ''}></td>`).join('');
      attendanceBody.appendChild(row);
    });
  }

  async function loadAttendance() {
    const day = daySelect.value;
    const date = dateSelect.value;
    if (!date) return;
    
    // Simulate loading from database
    // In production, replace with actual database call
    console.log(`Loading attendance for ${day} ${date}`);
  }

  async function loadSavedDates() {
    // Simulate loading saved dates
    // In production, load from actual database
    savedDates.innerHTML = '<option value="">-- Select Saved Record --</option>';
    
    // Add some demo data
    const today = new Date();
    for (let i = 0; i < 7; i++) {
      const date = new Date(today);
      date.setDate(date.getDate() - i);
      const dateStr = date.toISOString().split('T')[0];
      const dayStr = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][date.getDay()];
      
      const option = document.createElement('option');
      option.value = `${dayStr}_${dateStr}`;
      option.textContent = `${dayStr}_${dateStr}`;
      savedDates.appendChild(option);
    }
  }

  async function setClassroomLocation() {
    if (!navigator.geolocation) {
      showFeedback('session-status', 'Geolocation not supported', 'error');
      return;
    }
    
    const button = $('set-location-btn');
    button.disabled = true;
    button.textContent = 'Getting location...';
    
    navigator.geolocation.getCurrentPosition(
      (position) => {
        classroomLocation.lat = position.coords.latitude;
        classroomLocation.lon = position.coords.longitude;
        
        button.disabled = false;
        button.textContent = 'Location Set ✓';
        button.classList.add('success-btn');
        
        showFeedback('session-status', 
          `Classroom location set to: ${classroomLocation.lat.toFixed(6)}, ${classroomLocation.lon.toFixed(6)}`, 
          'success'
        );
        
        setTimeout(() => {
          button.textContent = 'Set Current Location as Classroom';
          button.classList.remove('success-btn');
        }, 3000);
      },
      (error) => {
        button.disabled = false;
        button.textContent = 'Set Current Location as Classroom';
        showFeedback('session-status', `Failed to get location: ${error.message}`, 'error');
      },
      {
        enableHighAccuracy: true,
        timeout: 30000, // Increased timeout
        maximumAge: 0
      }
    );
  }

  async function startQRSession() {
    if (currentRole !== 'teacher') return;
    
    const subjectIndex = parseInt(subjectSelect.value);
    const day = daySelect.value;
    const date = dateSelect.value;
    const radius = parseInt(radiusInput.value) || 35;
    const duration = parseInt(expireMinsInput.value) || 5;
    const subjects = subjectsByDay[day] || [];
    const subjectName = subjects[subjectIndex];
    
    if (!date || !subjectName) {
      showFeedback('session-status', 'Please select date and subject', 'error');
      return;
    }
    
    // Create session
    const sessionToken = generateSessionToken();
    const expiresAt = new Date(Date.now() + duration * 60 * 1000);
    
    activeSession = {
      token: sessionToken,
      day,
      date,
      subjectIndex,
      subjectName,
      radius,
      expiresAt,
      classroomLocation: { ...classroomLocation }
    };
    
    // Generate QR code
    const qrData = {
      token: sessionToken,
      action: 'mark_attendance',
      timestamp: Date.now()
    };
    
    const qrElement = $('qrcode');
    qrElement.innerHTML = '';
    
    new QRCode(qrElement, {
      text: JSON.stringify(qrData),
      width: 200,
      height: 200,
      correctLevel: QRCode.CorrectLevel.M
    });
    
    // Update UI
    $('start-qr-btn').style.display = 'none';
    $('end-qr-btn').style.display = '';
    $('qr-display').classList.remove('hidden');
    
    $('qr-info').innerHTML = `
      <strong>Active Session:</strong><br>
      Subject: ${subjectName}<br>
      Date: ${date}<br>
      Expires: ${expiresAt.toLocaleTimeString()}<br>
      Radius: ${radius}m
    `;
    
    showFeedback('session-status', 
      `QR session started for ${subjectName}. Students can now scan to mark attendance.`, 
      'success'
    );
    
    // Auto-expire session
    setTimeout(() => {
      if (activeSession?.token === sessionToken) {
        endQRSession();
      }
    }, duration * 60 * 1000);
  }

  function endQRSession() {
    if (activeSession) {
      showFeedback('session-status', 
        `Session ended for ${activeSession.subjectName}`, 
        'notice'
      );
    }
    
    activeSession = null;
    $('start-qr-btn').style.display = '';
    $('end-qr-btn').style.display = 'none';
    $('qr-display').classList.add('hidden');
    $('qrcode').innerHTML = '';
    $('qr-info').innerHTML = '';
    
    $('session-status').style.display = 'none';
  }

  async function markAttendanceFromQR() {
    const qrInput = $('qr-input').value.trim();
    
    if (!qrInput) {
      showFeedback('scan-feedback', 'Please paste the QR code content', 'error');
      return;
    }
    
    try {
      const qrData = JSON.parse(qrInput);
      
      if (!qrData.token || qrData.action !== 'mark_attendance') {
        throw new Error('Invalid QR code format');
      }
      
      // Simulate session validation
      if (!activeSession || activeSession.token !== qrData.token) {
        throw new Error('Invalid or expired session');
      }
      
      if (new Date() > activeSession.expiresAt) {
        throw new Error('Session has expired');
      }
      
      // Get location
      if (!navigator.geolocation) {
        throw new Error('Geolocation not supported');
      }
      
      showFeedback('scan-feedback', 'Checking your location...', 'notice');
      
      navigator.geolocation.getCurrentPosition(
        async (position) => {
          const distance = calculateDistance(
            position.coords.latitude,
            position.coords.longitude,
            activeSession.classroomLocation.lat,
            activeSession.classroomLocation.lon
          );
          
          if (distance > activeSession.radius) {
            showFeedback('scan-feedback', 
              `You are too far from the classroom (${Math.round(distance)}m away). Please move closer.`, 
              'error'
            );
            return;
          }
          
          // Mark attendance
          await markStudentPresent(activeSession);
          
          showFeedback('scan-feedback', 
            `Attendance marked successfully for ${activeSession.subjectName}! You are ${Math.round(distance)}m from classroom.`, 
            'success'
          );
          
          // Clear input
          $('qr-input').value = '';
        },
        (error) => {
          showFeedback('scan-feedback', 
            `Failed to get your location: ${error.message}. Please enable location services and try again.`, 
            'error'
          );
        },
        {
          enableHighAccuracy: true,
          timeout: 30000,
          maximumAge: 300000 // 5 minutes
        }
      );
      
    } catch (error) {
      showFeedback('scan-feedback', `Error: ${error.message}`, 'error');
    }
  }

  async function markStudentPresent(session) {
    // In production, this would update the database
    // For now, we'll just update the UI if the table is showing the same day/date
    
    if (daySelect.value === session.day && dateSelect.value === session.date) {
      // Find current user's row (simulated)
      const studentKey = currentUser?.studentKey || "R23XV1M6701 - Addanki Harshitha"; // Demo
      const rows = attendanceBody.querySelectorAll('tr');
      
      for (let row of rows) {
        const studentName = row.cells[0].textContent;
        if (studentName === studentKey) {
          const checkbox = row.cells[session.subjectIndex + 1]?.querySelector('input[type="checkbox"]');
          if (checkbox) {
            checkbox.checked = true;
            row.style.backgroundColor = '#d4edda'; // Highlight the row
            setTimeout(() => {
              row.style.backgroundColor = '';
            }, 3000);
          }
          break;
        }
      }
    }
    
    console.log('Attendance marked for:', session);
  }

  function showAddSubjectModal() {
    const modal = $('add-subject-modal');
    modal.classList.remove('hidden');
    $('new-subject-input').focus();
  }

  function hideAddSubjectModal() {
    const modal = $('add-subject-modal');
    modal.classList.add('hidden');
    $('new-subject-input').value = '';
  }

  function addSubject() {
    const newSubject = $('new-subject-input').value.trim();
    if (!newSubject) {
      alert('Please enter a subject name');
      return;
    }
    
    const day = daySelect.value;
    if (!subjectsByDay[day].includes(newSubject)) {
      subjectsByDay[day].push(newSubject);
      loadSubjects();
      buildAttendanceTable();
      
      showFeedback('session-status', `Subject "${newSubject}" added successfully`, 'success');
    } else {
      alert('This subject already exists for this day');
    }
    
    hideAddSubjectModal();
  }

  async function saveAttendance() {
    if (currentRole !== 'teacher') {
      alert('Only teachers can save attendance');
      return;
    }
    
    const day = daySelect.value;
    const date = dateSelect.value;
    
    if (!date) {
      alert('Please select a date');
      return;
    }
    
    // Collect attendance data
    const attendanceData = {};
    const subjects = subjectsByDay[day] || [];
    
    const rows = attendanceBody.querySelectorAll('tr');
    rows.forEach(row => {
      const studentName = row.cells[0].textContent;
      attendanceData[studentName] = [];
      
      for (let i = 1; i < row.cells.length; i++) {
        const checkbox = row.cells[i].querySelector('input[type="checkbox"]');
        attendanceData[studentName].push(checkbox ? checkbox.checked : false);
      }
    });
    
    // Save to storage (simulate database save)
    const recordKey = `${day}_${date}`;
    const record = {
      day,
      date,
      subjects,
      attendance: attendanceData,
      savedAt: new Date().toISOString(),
      savedBy: currentUser?.uid
    };
    
    try {
      // In production, save to Firebase
      localStorage.setItem(`attendance_${recordKey}`, JSON.stringify(record));
      
      alert(`Attendance saved successfully for ${day}, ${date}`);
      await loadSavedDates();
      
      showFeedback('session-status', 'Attendance data saved to database', 'success');
    } catch (error) {
      alert('Failed to save attendance: ' + error.message);
      showFeedback('session-status', 'Failed to save attendance', 'error');
    }
  }

  async function exportCSV() {
    if (currentRole !== 'teacher') {
      alert('Only teachers can export data');
      return;
    }
    
    const day = daySelect.value;
    const date = dateSelect.value;
    const subjects = subjectsByDay[day] || [];
    
    if (!date) {
      alert('Please select a date');
      return;
    }
    
    // Generate CSV content
    let csvContent = `Attendance Report\n`;
    csvContent += `Date:,${date}\n`;
    csvContent += `Day:,${day}\n\n`;
    csvContent += `Student,${subjects.join(',')}\n`;
    
    const rows = attendanceBody.querySelectorAll('tr');
    rows.forEach(row => {
      const studentName = row.cells[0].textContent;
      const attendance = [];
      
      for (let i = 1; i < row.cells.length; i++) {
        const checkbox = row.cells[i].querySelector('input[type="checkbox"]');
        attendance.push(checkbox && checkbox.checked ? 'Present' : 'Absent');
      }
      
      csvContent += `"${studentName}",${attendance.join(',')}\n`;
    });
    
    // Download CSV
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `Attendance_${day}_${date}.csv`;
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(link.href);
    
    showFeedback('session-status', 'CSV file downloaded successfully', 'success');
  }

  function checkForQRScan() {
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    
    if (token) {
      // Auto-fill the QR input if user comes from QR scan
      setTimeout(() => {
        if (currentRole === 'student') {
          const qrData = {
            token: token,
            action: 'mark_attendance',
            timestamp: Date.now()
          };
          $('qr-input').value = JSON.stringify(qrData);
          showFeedback('scan-feedback', 'QR code detected! Click Submit to mark attendance.', 'notice');
        }
      }, 1000);
    }
  }

  // Utility functions
  function generateSessionToken() {
    return Math.random().toString(36).substring(2, 15) + 
           Math.random().toString(36).substring(2, 15);
  }

  function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371e3; // Earth's radius in meters
    const φ1 = lat1 * Math.PI/180;
    const φ2 = lat2 * Math.PI/180;
    const Δφ = (lat2-lat1) * Math.PI/180;
    const Δλ = (lon2-lon1) * Math.PI/180;

    const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
              Math.cos(φ1) * Math.cos(φ2) *
              Math.sin(Δλ/2) * Math.sin(Δλ/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

    return R * c; // Distance in meters
  }

  function showFeedback(elementId, message, type) {
    const element = $(elementId);
    if (!element) return;
    
    element.className = type;
    element.innerHTML = message;
    element.style.display = 'block';
    
    // Auto-hide success and notice messages after 5 seconds
    if (type === 'success' || type === 'notice') {
      setTimeout(() => {
        element.style.display = 'none';
      }, 5000);
    }
  }

  // Handle Enter key in forms
  document.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      if (e.target.closest('#login-section')) {
        handleLogin();
      } else if (e.target.closest('#student-scan-section')) {
        markAttendanceFromQR();
      } else if (e.target.id === 'new-subject-input') {
        addSubject();
      }
    }
  });

  // Auto-refresh session status
  setInterval(() => {
    if (activeSession && new Date() > activeSession.expiresAt) {
      endQRSession();
    }
  }, 30000); // Check every 30 seconds

  // Demo login credentials helper
  setTimeout(() => {
    if (loginSection && !loginSection.classList.contains('hidden')) {
      const helpText = document.createElement('div');
      helpText.className = 'notice';
      helpText.innerHTML = `
        <strong>Demo Login:</strong><br>
        Teacher: teacher@demo.com / password<br>
        Student: student@demo.com / password<br>
        Viewer: viewer@demo.com / password
      `;
      loginSection.appendChild(helpText);
    }
  }, 1000);

</script>
</body>
</html>
