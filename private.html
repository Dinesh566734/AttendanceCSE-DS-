<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Attendance</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; margin:0; background:#f5f7fa; color:#2c3e50; }
    header { background:#2c3e50; color:white; padding:16px 24px; display:flex; justify-content:space-between; align-items:center; }
    header h1 { margin:0; font-size:1.4rem; }
    .btn { padding:8px 14px; border:none; border-radius:6px; cursor:pointer; font-weight:600; transition:all .2s ease; }
    .btn:hover { transform:translateY(-1px); }
    .btn.danger { background:#e74c3c; color:white; }
    .btn.danger:hover { background:#c0392b; }
    .btn.primary { background:#3498db; color:white; }
    .btn.primary:hover { background:#2980b9; }
    .btn.secondary { background:#95a5a6; color:white; }
    .btn.secondary:hover { background:#7f8c8d; }
    .container { max-width:1000px; margin:24px auto; background:white; padding:20px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,.1); }
    .filters { 
      display:flex; 
      gap:12px; 
      margin-bottom:20px; 
      flex-wrap:wrap; 
      align-items:end;
      padding:16px;
      background:#f8f9fa;
      border-radius:8px;
      border:1px solid #e9ecef;
    }
    .filter-group {
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .filter-group label {
      font-size:0.9rem;
      font-weight:600;
      color:#495057;
    }
    input[type="date"] { 
      padding:8px; 
      border:1px solid #ced4da; 
      border-radius:6px; 
      font-size:0.9rem;
    }
    .semester-buttons {
      display:flex;
      gap:8px;
      align-items:end;
    }
    h2 { margin-top:0; color:#2c3e50; }
    h3 { color:#34495e; margin-top:24px; margin-bottom:12px; }
    table { width:100%; border-collapse:collapse; margin-top:16px; border-radius:8px; overflow:hidden; }
    th, td { border:1px solid #e2e8f0; padding:10px; text-align:center; font-size:0.95rem; }
    th { background:#34495e; color:white; font-weight:600; }
    tr:nth-child(even) { background:#f9fafb; }
    tr:hover { background:#f1f5f9; }
    .muted { color:#64748b; font-style:italic; }
    .status-present { color:#27ae60; font-weight:600; }
    .status-absent { color:#e74c3c; font-weight:600; }
    .percentage {
      font-weight:600;
    }
    .percentage.good { color:#27ae60; }
    .percentage.warning { color:#f39c12; }
    .percentage.danger { color:#e74c3c; }
  </style>
</head>
<body>
  <header>
    <h1>ðŸ“– My Attendance</h1>
    <button id="logout-btn" class="btn danger">Logout</button>
  </header>

  <div class="container">
    <div class="filters">
      <div class="filter-group">
        <label>From:</label>
        <input type="date" id="from-date">
      </div>
      <div class="filter-group">
        <label>To:</label>
        <input type="date" id="to-date">
      </div>
      <div class="semester-buttons">
        <button id="sem1-btn" class="btn secondary">Sem 1</button>
        <button id="sem2-btn" class="btn secondary">Sem 2</button>
        <button id="filter-btn" class="btn primary">Apply Filter</button>
      </div>
    </div>

    <h2 id="student-name">Loading...</h2>

    <h3>ðŸ“Š Attendance Summary</h3>
    <table>
      <thead>
        <tr><th>Subject</th><th>Classes Attended</th><th>Total Classes</th><th>Attendance %</th></tr>
      </thead>
      <tbody id="summary-body"><tr><td colspan="4" class="muted">No data available</td></tr></tbody>
    </table>

    <h3>ðŸ“… Day-wise Attendance Details</h3>
    <table>
      <thead>
        <tr><th>Date</th><th>Day</th><th>Subject</th><th>Status</th></tr>
      </thead>
      <tbody id="details-body"><tr><td colspan="4" class="muted">No data available</td></tr></tbody>
    </table>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCTx8SuwqsqqVzgsfPkaaMEirYeKWCqC5Y",
      authDomain: "attendance-dd096.firebaseapp.com",
      projectId: "attendance-dd096",
      storageBucket: "attendance-dd096.firebasestorage.app",
      messagingSenderId: "1064169386680",
      appId: "1:1064169386680:web:301de8d261c27216aeba4d"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const summaryBody = document.getElementById('summary-body');
    const detailsBody = document.getElementById('details-body');
    const studentNameEl = document.getElementById('student-name');
    const fromEl = document.getElementById('from-date');
    const toEl = document.getElementById('to-date');
    const filterBtn = document.getElementById('filter-btn');
    const sem1Btn = document.getElementById('sem1-btn');
    const sem2Btn = document.getElementById('sem2-btn');

    let currentStudentKey = null;

    document.getElementById('logout-btn').addEventListener('click', async ()=>{
      await signOut(auth);
      window.location.href = "index10.html";
    });

    function ymd(d){
      const y=d.getFullYear();
      const m=String(d.getMonth()+1).padStart(2,'0');
      const day=String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }

    function setSemesterDates(semester) {
      const year = new Date().getFullYear();
      if(semester === 1){
      fromEl.value = `${year}-06-30`;
      toEl.value   = `${year}-12-06`;
    } else if(semester === 2){
      fromEl.value = `${year}-12-08`;
      toEl.value   = `${year}-06-17`;
    }
    }

    (function setDefaultDates(){
      const now = new Date();
      toEl.value = ymd(now);
      const first = new Date(now.getFullYear(), now.getMonth(), 1);
      fromEl.value = ymd(first);
    })();

    async function getStudentKey(uid){
      const userDoc = await getDoc(doc(db, "users", uid));
      return userDoc.exists() ? userDoc.data().studentKey : null;
    }

    function getPercentageClass(percentage) {
      if (percentage >= 75) return 'good';
      if (percentage >= 60) return 'warning';
      return 'danger';
    }

    async function loadAttendance(studentKey){
      if (!studentKey) return;
      
      summaryBody.innerHTML = '<tr><td colspan="4" class="muted">Loading...</td></tr>';
      detailsBody.innerHTML = '<tr><td colspan="4" class="muted">Loading...</td></tr>';
      
      try {
        const snap = await getDocs(collection(db, "attendance"));
        const summary = {};
        let detailsRows = '';
        const from = fromEl.value;
        const to = toEl.value;
        let totalRecordsFound = 0;

        snap.forEach(docSnap => {
          const data = docSnap.data();
          const dateStr = data.date;
          
          // Skip if outside date range
          if (from && dateStr < from) return;
          if (to && dateStr > to) return;

          const subjects = data.subjects || [];
          const day = data.day || '';
          const studentEntry = data.data && data.data[studentKey];

          if (studentEntry && Array.isArray(studentEntry)) {
            totalRecordsFound++;
            subjects.forEach((sub, i) => {
              if (!summary[sub]) summary[sub] = {present:0,total:0};
              summary[sub].total++;
              const present = studentEntry[i] === true;
              if (present) summary[sub].present++;
              
              const statusClass = present ? 'status-present' : 'status-absent';
              const statusText = present ? 'Present' : 'Absent';
              detailsRows += `<tr><td>${dateStr}</td><td>${day}</td><td>${sub}</td><td class="${statusClass}">${statusText}</td></tr>`;
            });
          }
        });

        // Render summary
        summaryBody.innerHTML = '';
        if (Object.keys(summary).length === 0){
          summaryBody.innerHTML = '<tr><td colspan="4" class="muted">No attendance records found in the selected date range</td></tr>';
        } else {
          Object.keys(summary).sort().forEach(sub => {
            const {present,total} = summary[sub];
            const perc = total ? ((present/total)*100).toFixed(1) : 0;
            const percClass = getPercentageClass(parseFloat(perc));
            summaryBody.innerHTML += `<tr>
              <td><strong>${sub}</strong></td>
              <td>${present}</td>
              <td>${total}</td>
              <td class="percentage ${percClass}">${perc}%</td>
            </tr>`;
          });
        }

        // Render details (sort by date descending)
        if (detailsRows) {
          const rows = detailsRows.split('</tr>').filter(row => row.trim());
          const sortedRows = rows.sort((a, b) => {
            const dateA = a.match(/<td>([^<]+)<\/td>/)?.[1] || '';
            const dateB = b.match(/<td>([^<]+)<\/td>/)?.[1] || '';
            return dateB.localeCompare(dateA);
          });
          detailsBody.innerHTML = sortedRows.map(row => row + '</tr>').join('');
        } else {
          detailsBody.innerHTML = '<tr><td colspan="4" class="muted">No attendance details found in the selected date range</td></tr>';
        }

      } catch (error) {
        console.error('Error loading attendance:', error);
        summaryBody.innerHTML = '<tr><td colspan="4" class="muted">Error loading data</td></tr>';
        detailsBody.innerHTML = '<tr><td colspan="4" class="muted">Error loading data</td></tr>';
      }
    }

    // Event listeners
    filterBtn.addEventListener('click', ()=>{
      if (currentStudentKey) {
        loadAttendance(currentStudentKey);
      }
    });

    sem1Btn.addEventListener('click', () => {
      setSemesterDates(1);
      if (currentStudentKey) {
        loadAttendance(currentStudentKey);
      }
    });

    sem2Btn.addEventListener('click', () => {
      setSemesterDates(2);
      if (currentStudentKey) {
        loadAttendance(currentStudentKey);
      }
    });

    onAuthStateChanged(auth, async (user)=>{
      if (!user){
        window.location.href = "index10.html";
      } else {
        const studentKey = await getStudentKey(user.uid);
        currentStudentKey = studentKey;
        
        if (studentKey) {
          // Extract name from studentKey format "ROLLNUMBER - NAME"
          const nameParts = studentKey.split(' - ');
          const displayName = nameParts.length > 1 ? nameParts.slice(1).join(' - ') : studentKey;
          studentNameEl.textContent = `Welcome, ${displayName}`;
          
          // Load initial attendance data
          loadAttendance(studentKey);
        } else {
          studentNameEl.textContent = `Welcome, ${user.email}`;
          summaryBody.innerHTML = '<tr><td colspan="4" class="muted">Student key not found. Please contact admin.</td></tr>';
        }
      }
    });
  </script>
</body>
</html>